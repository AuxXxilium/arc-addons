#!/usr/bin/env bash
#
# Copyright (C) 2025 AuxXxilium
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

if ! type -p perl; then
  echo "Installing Perl..."
  synopkg install_from_server Perl
fi

if ! type -p perl; then
  echo "Perl not found"
  exit 1
fi

modprobe hwmon-vid
modprobe it87
modprobe adt7470
modprobe adt7475
modprobe nct6683
modprobe nct6775
modprobe coretemp
modprobe k10temp

echo 'Y' | sensors-detect --auto >"/tmp/sensors.log"
grep -Eo 'Driver\s*:\s*\w+' "/tmp/sensors.log" | awk -F': ' '{print $2}'

sensors

generate_fancontrol_config() {
  # Or use pwmconfig to generate /etc/fancontrol interactively.
  local DEVPATH DEVNAME FCTEMPS FCFANS MINTEMP MAXTEMP MINSTART MINSTOP
  CORETEMP="$(find "/sys/devices/platform/" -name "temp1_input" | grep -E 'coretemp|k10temp' | sed -n 's|.*/\(hwmon.*\/temp1_input\).*|\1|p')"
  # shellcheck disable=SC2044
  for P in $(find "/sys/devices/platform/" -name "temp1_input"); do
    D="$(echo "${P}" | sed -n 's|.*/\(devices/platform/[^/]*\)/.*|\1|p')"
    I="$(echo "${P}" | sed -n 's|.*hwmon\([0-9]\).*|\1|p')"
    DEVPATH="${DEVPATH} hwmon${I}=${D}"
    DEVNAME="${DEVNAME} hwmon${I}=$(cat /sys/${D}/*/*/name)"
    for F in $(find "/sys/${D}" -name "fan[0-9]_input"); do
      IDX="$(echo "${F}" | sed -n 's|.*fan\([0-9]\)_input|\1|p')"
      FCTEMPS="${FCTEMPS} hwmon${I}/pwm${IDX}=${CORETEMP}"
      FCFANS="${FCFANS} hwmon${I}/pwm${IDX}=hwmon${I}/fan${IDX}_input"
      MINTEMP="${MINTEMP} hwmon${I}/pwm${IDX}=30"
      MAXTEMP="${MAXTEMP} hwmon${I}/pwm${IDX}=70"
      MINSTART="${MINSTART} hwmon${I}/pwm${IDX}=150"
      MINSTOP="${MINSTOP} hwmon${I}/pwm${IDX}=50"
    done
    i=$((i + 1))
  done

  DEST="/etc/fancontrol"
  {
    echo "# Configuration file generated by pwmconfig, changes will be lost"
    echo "INTERVAL=10"
    echo "DEVPATH=$(echo ${DEVPATH})"
    echo "DEVNAME=$(echo ${DEVNAME})"
    echo "FCTEMPS=$(echo ${FCTEMPS})"
    echo "FCFANS=$(echo ${FCFANS})"
    echo "MINTEMP=$(echo ${MINTEMP})"
    echo "MAXTEMP=$(echo ${MAXTEMP})"
    echo "MINSTART=$(echo ${MINSTART})"
    echo "MINSTOP=$(echo ${MINSTOP})"
  } | tee "${DEST}" >/dev/null
}

echo "$@" | grep -wq "\-f" && rm -f /etc/fancontrol
if [ ! -f /etc/fancontrol ]; then
  generate_fancontrol_config
fi

killall fancontrol
fancontrol &

exit 0